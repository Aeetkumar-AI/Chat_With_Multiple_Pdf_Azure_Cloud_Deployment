import os
import glob
from typing import List
from langchain.schema import Document
from langchain_community.document_loaders import UnstructuredMarkdownLoader
from langchain_text_splitters import MarkdownHeaderTextSplitter, RecursiveCharacterTextSplitter

# ---------------------
# CONFIG
# ---------------------
CHUNK_SIZE = 1200
CHUNK_OVERLAP = 150


def load_docs(path: str) -> List[Document]:
    """Load all .md files from a directory and attach metadata."""
    docs = []
    for file in glob.glob(os.path.join(path, "*.md")):
        loader = UnstructuredMarkdownLoader(file)
        for doc in loader.load():
            doc.metadata["source_file"] = os.path.basename(file)
            docs.append(doc)

    print(f"[+] Loaded {len(docs)} markdown docs from {path}")
    return docs


def chunk_docs_markdown_recursive(docs: List[Document]) -> List[Document]:
    """Chunk docs using Markdown headers â†’ recursive splitting."""
    
    headers = [
        ("# ", "H1"),
        ("## ", "H2"),
        ("### ", "H3"),
        ("#### ", "H4"),
        ("##### ", "H5"),
        ("###### ", "H6"),
    ]

    # Split by Markdown headers
    markdown_splitter = MarkdownHeaderTextSplitter(
        headers_to_split_on=headers,
        strip_headers=False
    )

    # Recursive splitting config
    text_splitter = RecursiveCharacterTextSplitter(
        chunk_size=CHUNK_SIZE,
        chunk_overlap=CHUNK_OVERLAP,
        separators=["\n\n", "\n", ".", " "],
        length_function=len
    )

    markdown_recursive_chunks = []

    for doc in docs:
        filename = doc.metadata.get("source_file", "unknown")

        # Try header split
        try:
            md_splits = markdown_splitter.split_text(doc.page_content)
        except Exception as e:
            print(f"âš ï¸ Header split failed for {filename} â€” using whole document")
            md_splits = [Document(page_content=doc.page_content, metadata=doc.metadata)]

        # For each header section, recursively chunk only when large
        for md_doc in md_splits:
            md_doc.metadata["source_file"] = filename

            if len(md_doc.page_content) > CHUNK_SIZE:
                sub_chunks = text_splitter.split_documents([md_doc])
                for chunk in sub_chunks:
                    chunk.metadata["source_file"] = filename
                    markdown_recursive_chunks.append(chunk)
            else:
                markdown_recursive_chunks.append(md_doc)

    print("\n" + "=" * 80)
    print("ðŸ“¦ Markdown-Recursive Chunk Summary")
    print("=" * 80)
    print(f"Total source files processed : {len(docs)}")
    print(f"Total chunks created         : {len(markdown_recursive_chunks)}")
    print("=" * 80 + "\n")

    return markdown_recursive_chunks
